version: '3.7'

networks:
  mojaloop-itk-net:
    name: mojaloop-itk-net
    driver: bridge

services:

  # Django gateway (web)
  web:
    build: .
    container_name: gateway-web
    networks:
      - mojaloop-itk-net
    env_file: ./mojaloop-connector-load-test.env
    ports:
      - "8000:8000"
    volumes:
      - ./gateway:/app/gateway:rw
      - ./secrets:/app/secrets:ro
    depends_on:
      - db
      - redis
      - mojaloop-connector-load-test
    command: ["sh", "-c", "./scripts/wait-for-db.sh db && python gateway/manage.py migrate --noinput && gunicorn gateway.wsgi:application --bind 0.0.0.0:8000"]

  # Celery worker for async tasks
  celery:
    build: .
    container_name: gateway-celery
    networks:
      - mojaloop-itk-net
    env_file: ./mojaloop-connector-load-test.env
    volumes:
      - ./gateway:/app/gateway:rw
      - ./secrets:/app/secrets:ro
    depends_on:
      - redis
      - db
    command: ["sh", "-c", "./scripts/wait-for-db.sh db && celery -A gateway worker -l info"]

  # Postgres for persistence
  db:
    image: postgres:15-alpine
    networks:
      - mojaloop-itk-net
    environment:
      POSTGRES_DB: gateway
      POSTGRES_USER: gateway
      POSTGRES_PASSWORD: gateway
    volumes:
      - db_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  # Redis (already present previously) - used for cache and celery broker
  redis:
    networks:
      - mojaloop-itk-net
    image: "redis:6.2.4-alpine"
    ports:
      - "6379:6379"
    healthcheck:
      test: [ "CMD", "sh", "-c", "redis-cli ping" ]
      timeout: 20s
      retries: 10
      start_period: 40s
      interval: 30s

  # SDK Mojaloop (existing)
  mojaloop-connector-load-test:
    networks:
      - mojaloop-itk-net
    image: mojaloop/sdk-scheme-adapter:latest
    env_file: ./mojaloop-connector-load-test.env
    ports:
      - "4041:4000"  
      - "4001:4001" 
      - "4002:4002"
      - "9229:9229"
    depends_on:
      - redis
      - ml-testing-toolkit
    command: yarn nx run modules-api-svc:start
    volumes:
      - ./secrets:/opt/app/secrets
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4001" ]
      timeout: 20s
      retries: 10
      start_period: 40s
      interval: 30s

  # k6 load tester (optional)
  k6:
    image: grafana/k6
    networks:
      - mojaloop-itk-net
    depends_on:
      - mojaloop-connector-load-test
    volumes:
      - ../k6-load-test-script.js:/scripts/k6-load-test-script.js
    entrypoint: ["k6", "run", "/scripts/k6-load-test-script.js"]

  # Mock Hub / TTK (existing)
  ml-testing-toolkit:
    networks:
      mojaloop-itk-net:
        aliases:
          - ttkhubsim        
    image: node:18-alpine
    working_dir: /app
    command: node mock-hub-server.js
    volumes:
      - ./mock-hub-server.js:/app/mock-hub-server.js:ro
    ports:
      - "4040:4040"          
      - "5050:5050"         
    environment:
      - HUB_ONLY_MODE=true

  # UI du Testing Toolkit (existing)
  ml-testing-toolkit-ui:
    image: mojaloop/ml-testing-toolkit-ui:v15.1.3
    networks:
      - mojaloop-itk-net
    ports:
      - "6060:6060"
    environment:
      - API_BASE_URL=http://ml-testing-toolkit:5050
      - AUTH_ENABLED=FALSE
    command:
      - sh
      - /usr/share/nginx/start.sh

  # Nginx reverse proxy in front of Django (simple placeholder)
  nginx:
    image: nginx:stable-alpine
    networks:
      - mojaloop-itk-net
    ports:
      - "80:80"
    volumes:
      - ./deploy/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web

volumes:
  db_data:
    name: backend_db_data

