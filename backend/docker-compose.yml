networks:
  mojaloop-itk-net:
    name: mojaloop-itk-net
    driver: bridge

services:

  # Django gateway (web)
  web:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: gateway-web
    networks:
      - mojaloop-itk-net
    env_file: ./mojaloop-connector-load-test.env
    environment:
      USE_SQLITE: "True"
      SCHEME_ADAPTER_URL: "http://mojaloop-connector-load-test:4001"
      PYTHONPATH: "/app/gateway"
      DJANGO_SETTINGS_MODULE: "gateway.settings.dev"
    ports:
      - "8000:8000"
    volumes:
      - ./gateway:/app/gateway:rw
      - ./secrets:/app/secrets:ro
      - ./scripts:/app/scripts:ro
    depends_on:
      redis:
        condition: service_healthy
    command: ["sh", "/app/scripts/entrypoint.sh", "gunicorn", "gateway.wsgi:application", "--bind", "0.0.0.0:8000", "--workers", "2", "--reload"]
    restart: unless-stopped

  # Celery worker for async tasks
  celery:
    build: 
      context: .
      dockerfile: Dockerfile
    container_name: gateway-celery
    networks:
      - mojaloop-itk-net
    env_file: ./mojaloop-connector-load-test.env
    environment:
      USE_SQLITE: "True"
      SCHEME_ADAPTER_URL: "http://mojaloop-connector-load-test:4001"
      PYTHONPATH: "/app/gateway"
      DJANGO_SETTINGS_MODULE: "gateway.settings.dev"
    volumes:
      - ./gateway:/app/gateway:rw
      - ./secrets:/app/secrets:ro
      - ./scripts:/app/scripts:ro
    depends_on:
      redis:
        condition: service_healthy
      web:
        condition: service_started
    command: ["sh", "-c", "cd /app/gateway && celery -A gateway worker -l info --concurrency=2"]
    restart: unless-stopped

  # Redis (already present previously) - user for cached 
  redis:
    networks:
      - mojaloop-itk-net
    image: "redis:7-alpine"
    ports:
      - "6379:6379"
    command: redis-server --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      timeout: 5s
      retries: 5
      start_period: 10s
      interval: 10s
    restart: unless-stopped

  # SDK Mojaloop (existing)
  mojaloop-connector-load-test:
    networks:
      - mojaloop-itk-net
    image: mojaloop/sdk-scheme-adapter:latest
    env_file: ./mojaloop-connector-load-test.env
    environment:
      BACKEND_ENDPOINT: "http://web:8000"
    ports:
      - "4041:4000"  
      - "4001:4001" 
      - "4002:4002"
      - "9229:9229"
    depends_on:
      - redis
      - ml-testing-toolkit
    command: yarn nx run modules-api-svc:start
    volumes:
      - ./secrets:/opt/app/secrets
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:4001" ]
      timeout: 20s
      retries: 10
      start_period: 40s
      interval: 30s

  # k6 load tester (optional)
  k6:
    image: grafana/k6
    networks:
      - mojaloop-itk-net
    depends_on:
      - mojaloop-connector-load-test
    volumes:
      - ../k6-load-test-script.js:/scripts/k6-load-test-script.js
    entrypoint: ["k6", "run", "/scripts/k6-load-test-script.js"]

  # Mock Hub / TTK (existing)
  ml-testing-toolkit:
    networks:
      mojaloop-itk-net:
        aliases:
          - ttkhubsim        
    image: node:18-alpine
    working_dir: /app
    command: node mock-hub-server.js
    volumes:
      - ./mock-hub-server.js:/app/mock-hub-server.js:ro
    ports:
      - "4040:4040"          
      - "5050:5050"         
    environment:
      - HUB_ONLY_MODE=true

  # UI du Testing Toolkit (existing)
  ml-testing-toolkit-ui:
    image: mojaloop/ml-testing-toolkit-ui:v15.1.3
    networks:
      - mojaloop-itk-net
    ports:
      - "6060:6060"
    environment:
      - API_BASE_URL=http://ml-testing-toolkit:5050
      - AUTH_ENABLED=FALSE
    command:
      - sh
      - /usr/share/nginx/start.sh

  # Nginx reverse proxy in front of Django (simple placeholder)
  nginx:
    image: nginx:stable-alpine
    networks:
      - mojaloop-itk-net
    ports:
      - "80:80"
    volumes:
      - ./deploy/nginx/default.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - web

